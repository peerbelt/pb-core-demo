machine:
  node:
    version: 0.10.32
  python:
    version: 2.7.3
  ruby:
    version: rbx-2.2.6
  services:
    - docker
  environment:
    USER_DIR: /tmp
    ID_RSA: /home/ubuntu/.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa

dependencies:
  pre:
    - pip install awscli
    - wget https://github.com/docker/machine/releases/download/v0.1.0-rc5/docker-machine_linux-amd64
    - mv docker-machine_linux-amd64 docker-machine
    - chmod 755 docker-machine
    - sed -i "s/AWS_KEY/$AWS_ACCESS_KEY_ID/g" config
    - sed -i "s|AWS_SECRET|$AWS_SECRET_ACCESS_KEY|g" config
    - gem install fog
  override:
    - docker info
    - aws s3 cp s3://devops-peerbelt/machines/CD/images/latest/pb-core-saas-website-latest.tar . 
    - aws s3 cp s3://devops-peerbelt/machines/CD/images/latest/pb-core-console-latest.tar .
    - aws s3 cp s3://devops-peerbelt/machines/CD/images/latest/pb-core-console-api-latest.tar . 
    - aws s3 cp s3://devops-peerbelt/machines/CD/images/latest/pb-core-tracking-api-latest.tar .
    - aws s3 cp s3://devops-peerbelt/machines/CD/images/latest/pb-core-consumer-api-latest.tar .
    - aws s3 cp s3://devops-peerbelt/machines/CD/images/latest/pb-core-digest-latest.tar .
    - aws s3 cp s3://devops-peerbelt/machines/CD/elasticsearch.tar .
    - docker load -i pb-core-saas-website-latest.tar
    - docker load -i pb-core-console-latest.tar

test:
  override:
    - docker run -d -p 44444:80 peerbelt/pb-core-saas-website
    - docker run -d -p 44445:80 peerbelt/pb-core-console
    - curl --retry 10 --retry-delay 5 -v http://localhost:44444
    - curl --retry 10 --retry-delay 5 -v http://localhost:44445

deployment:
    staging:
      branch: cd
      commands:
        # Creates the EC2 instance
        - ./docker-machine create --driver rackspace cd-eu-peerbelt-$CIRCLE_BUILD_NUM
        # Pushes the machine private key to S3
        
        # Install Cassandra and Elastic Search images
        - ssh -i  $ID_RSA root@`./docker-machine ip` 'sudo docker run -d --name pb_cassandra spotify/cassandra:latest'
        - scp -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa elasticsearch.tar root@`./docker-machine ip`:/$USER_DIR
        - ssh -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa root@`./docker-machine ip` 'sudo docker load -i $USER_DIR/elasticsearch.tar'
        - ssh -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa root@`./docker-machine ip` 'sudo docker run -d --name pb_elasticsearch -p 9200:9200 peerbelt/elasticsearch'
        # Copies the services and Nginx config to the new EC2
        - ssh -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa root@`./docker-machine ip` 'sudo apt-get install -y nginx; sudo rm -rf /etc/nginx/sites-enabled/default'
        - scp -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa pb-core-saas-website-latest.tar root@`./docker-machine ip`:$USER_DIR
        - scp -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa pb-core-console-latest.tar root@`./docker-machine ip`:$USER_DIR
        - scp -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa pb-core-console-api-latest.tar root@`./docker-machine ip`:$USER_DIR
        - scp -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa pb-core-tracking-api-latest.tar root@`./docker-machine ip`:$USER_DIR
        - scp -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa pb-core-consumer-api-latest.tar root@`./docker-machine ip`:$USER_DIR
        - scp -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa pb-core-digest-latest.tar root@`./docker-machine ip`:$USER_DIR
        - scp -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa pb_services.nginx root@`./docker-machine ip`:$USER_DIR/pb_services.nginx
        - ssh -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa root@`./docker-machine ip` 'sudo mv $USER_DIR/pb_services.nginx /etc/nginx/sites-available/pb_services.nginx'
        - ssh -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa root@`./docker-machine ip` 'sudo  ln -s  /etc/nginx/sites-available/pb_services.nginx /etc/nginx/sites-enabled/pb_services.nginx'
        # Starts the services
        - ssh -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa root@`./docker-machine ip` 'sudo docker load -i $USER_DIR/pb-core-saas-website-latest.tar'
        - ssh -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa root@`./docker-machine ip` 'sudo docker load -i $USER_DIR/pb-core-console-latest.tar'
        - ssh -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa root@`./docker-machine ip` 'sudo docker load -i $USER_DIR/pb-core-console-api-latest.tar'
        - ssh -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa root@`./docker-machine ip` 'sudo docker load -i $USER_DIR/pb-core-tracking-api-latest.tar'
        - ssh -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa root@`./docker-machine ip` 'sudo docker load -i $USER_DIR/pb-core-consumer-api-latest.tar'
        - ssh -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa root@`./docker-machine ip` 'sudo docker load -i $USER_DIR/pb-core-digest-latest.tar'
        - ssh -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa root@`./docker-machine ip` 'sudo docker run --name pb-core-saas-website -d -p 44444:80 peerbelt/pb-core-saas-website'
        - ssh -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa root@`./docker-machine ip` 'sudo docker run --name pb-core-console -d -p 44445:80 peerbelt/pb-core-console'
        - ssh -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa root@`./docker-machine ip` 'sudo docker run --name pb-core-console-api -d -p 33333:3000  peerbelt/pb-core-console-api'
        - ssh -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa root@`./docker-machine ip` 'sudo docker run --name pb-core-tracking-api -d -p 22222:3001 --link pb_cassandra:pb_cassandra peerbelt/pb-core-tracking-api'
        - ssh -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa root@`./docker-machine ip` 'sudo docker run --name pb-core-consumer-api -d -p 11111:3000 --link pb_elasticsearch:pb_elasticsearch peerbelt/pb-core-consumer-api'
        - ssh -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa root@`./docker-machine ip` 'sudo docker run --name pb-core-digest -d --link pb_cassandra:pb_cassandra --link pb_elasticsearch:pb_elasticsearch peerbelt/pb-core-digest'
        - ssh -i ../.docker/machines/cd-eu-peerbelt-$CIRCLE_BUILD_NUM/id_rsa root@`./docker-machine ip` 'sudo service nginx restart'
