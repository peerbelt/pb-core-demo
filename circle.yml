machine:
  node:
    version: 0.10.32
  python:
    version: 2.7.3
  ruby:
    version: 2.1.5
  services:
    - docker

dependencies:
  pre:
    - pip install awscli
    - pip install softlayer
#    - wget https://github.com/docker/machine/releases/download/v0.1.0-rc5/docker-machine_linux-amd64
#    - mv docker-machine_linux-amd64 docker-machine
#    - chmod 755 docker-machinei
    - cp /home/ubuntu/pb-core-demo/.softlayer /home/ubuntu/.softlayer
    - sed -i "s|SL_USER_REPLACE|$SL_USER|g" /home/ubuntu/.softlayer
    - sed -i "s/AWS_KEY/$AWS_ACCESS_KEY_ID/g" config
    - sed -i "s|AWS_SECRET|$AWS_SECRET_ACCESS_KEY|g" config
    - sed "s/license_key\=*/license_key\=$NEWRELIC_NON_PROD/g" nrsysmond.cfg
  override:
    - docker info
    - aws s3 cp s3://devops-peerbelt/machines/CD/images/latest/pb-core-saas-website-latest.tar . 
    - aws s3 cp s3://devops-peerbelt/machines/CD/images/latest/pb-core-console-latest.tar .
    - aws s3 cp s3://devops-peerbelt/machines/CD/images/latest/pb-core-console-api-latest.tar . 
    - aws s3 cp s3://devops-peerbelt/machines/CD/images/latest/pb-core-tracking-api-latest.tar .
    - aws s3 cp s3://devops-peerbelt/machines/CD/images/latest/pb-core-consumer-api-latest.tar .
    - aws s3 cp s3://devops-peerbelt/machines/CD/images/latest/pb-core-digest-latest.tar .
    - aws s3 cp s3://devops-peerbelt/machines/CD/elasticsearch-single-sample.tar .
    - aws s3 cp s3://devops-peerbelt/machines/CD/cassandra-single-sample.tar .
 #   - docker load -i pb-core-saas-website-latest.tar
 #   - docker load -i pb-core-console-latest.tar

test:
  override:
    - echo "no tests so far"
  #  - docker run -d -p 44444:80 peerbelt/pb-core-saas-website
  #  - docker run -d -p 44445:80 peerbelt/pb-core-console
  #  - curl --retry 10 --retry-delay 5 -v http://localhost:44444
  #  - curl --retry 10 --retry-delay 5 -v http://localhost:44445

deployment:
    cd:
      branch: cd
      commands:
        # Creates the EC2 instance
       # - ./docker-machine create --driver rackspace --rackspace-image-id e46ad403-db4b-405a-bbd1-1bc5da9137b5 --rackspace-flavor-id "general1-4" cd-iad-peerbelt-$CIRCLE_BUILD_NUM
       # - cp $HOME/.docker/machines/cd-iad-peerbelt-$CIRCLE_BUILD_NUM/id_rsa id_rsa-$CIRCLE_BUILD_NUM
        # Pushes the machine private key to S3
       # - aws s3 cp ../.docker/machines/cd-iad-peerbelt-$CIRCLE_BUILD_NUM/id_rsa s3://devops-peerbelt/ec2-keys/CD/id_rsa_$CIRCLE_BUILD_NUM 
       # - aws s3 cp ../.docker/machines/cd-iad-peerbelt-$CIRCLE_BUILD_NUM/id_rsa s3://devops-peerbelt/ec2-keys/CD/id_rsa_latest
        - slcli -y vs create -H "sl-$CIRCLE_BUILD_NUM-web-tor01" -D "peerbelt.com" -c 16 -m 16384 -d "tor01" -k "root-user-web-key" -n "1000" --billing 'hourly' --image $IMAGE_GUID
        
       
        #Deploy service containers 
        - /bin/bash -x ./deploy-compose.sh
