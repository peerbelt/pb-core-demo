machine:
#  node:
#    version: 0.10.32
  python:
    version: 2.7.3
#  ruby:
#    version: 2.1.5
  services:
    - docker

dependencies:
  pre:
    - pip install awscli
    - pip install softlayer
    - cp /home/ubuntu/pb-core-demo/.softlayer /home/ubuntu/.softlayer
    - sed -i "s|SL_USER_REPLACE|$SL_USER|g" /home/ubuntu/.softlayer
    - sed -i "s|SL_API_KEY_REPLACE|$SL_API_KEY|g" /home/ubuntu/.softlayer
    - sed -i "s/AWS_KEY/$AWS_ACCESS_KEY_ID/g" config
    - sed -i "s|AWS_SECRET|$AWS_SECRET_ACCESS_KEY|g" config
    - sed -i "s/license_key\=*/license_key\=$NEWRELIC_NON_PROD/g" nrsysmond.cfg
    - sed -i "s/TRAPI_ACCESS_TOKEN/$TRACKINGAPI_ACCESS_TOKEN/g" docker-compose.yml
    - sed -i "s/NEWRELIC_LICENSE/$NEWRELIC_PROD/g" docker-compose.yml
    - aws s3 cp s3://devops-peerbelt/sl_keys/id_rsa .
    - chmod 400 id_rsa
  override:
    - docker info
    - aws s3 cp s3://devops-peerbelt/machines/CD/images/latest/pb-core-saas-website-latest.tar . 
    - aws s3 cp s3://devops-peerbelt/machines/CD/images/latest/pb-core-console-latest.tar .
    - aws s3 cp s3://devops-peerbelt/machines/CD/images/latest/pb-core-console-api-latest.tar . 
    - aws s3 cp s3://devops-peerbelt/machines/CD/images/latest/pb-core-tracking-api-latest.tar .
    - aws s3 cp s3://devops-peerbelt/machines/CD/images/latest/pb-core-consumer-api-latest.tar .
    - aws s3 cp s3://devops-peerbelt/machines/CD/images/latest/pb-core-digest-latest.tar .

test:
  override:
    - echo "No tests so far"
deployment:
    production:
      branch: [prod]
      commands:
        # Creates the SL instance
        - slcli -y vs create -H "sl-$CIRCLE_BUILD_NUM-web-wdc04" -D "peerbelt.com" -c 8 -m 8192 -d "wdc04" -k "root-user-web-key" -n "1000" --image $IMAGE_GUID
        #Deploy services and containers 
        - /bin/bash -x ./deploy-compose.sh
